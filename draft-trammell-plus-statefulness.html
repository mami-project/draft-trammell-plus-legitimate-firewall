<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Transport-Independent Path Layer State Management</title>

<style type="text/css">/*<![CDATA[*/
@viewport {
  zoom: 1.0;
  width: extend-to-zoom;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}

@media screen and (min-width: 1024px) {
  ul.toc, #rfc\.toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 500px);
    width: 300px;
    padding: 0 1em;
    z-index: 1;
  }
  #rfc\.toc {
    top: 16px;
  }
  ul.toc {
    top: 80px;
    overflow: auto;
  }

  body {
    padding-left: 1.5em;
    padding-right: 29em;
  }
}

body {
  font: 15px "Helvetica Neue",Helvetica,Arial,sans-serif;
  color: #333;
  font-size-adjust: 0.5;
  line-height: 130%;
  margin: 2.5em auto;
  max-width: 724px;
}

.title, .filename, h1, h2, h3, h4 {
  font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
  font-size-adjust: 0.5;
  font-weight: 500;
  color: #333;
  line-height: 100%;
  margin: 0.8em 0 0.3em;
}
.title { font-size: 36px; }
h1 { font-size: 30px; }
h2 { font-size: 24px; }
h3, h4 { font-size: 18px; }
h1 a[href], h2 a[href], h3 a[href], h4 a[href] {
  color: #333;
}

ul.toc li {
  list-style: none;
  text-indent: -2.5em;
  padding-left: 2.5em;
  padding-bottom: 5px;
  margin: 0;
}
ul.toc, ul.toc ul {
  margin: 0 0 0 1.5em;
}

table {
  margin-left: 0em;
  border-collapse: collapse;
}
th {
  text-align: left;
  border-bottom: 2px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
  vertical-align: top;
}
tr:nth-child(2n+1) > td,
tr:nth-child(2n+1) > th {
  background-color: #f9f9f9;
}
td.reference {
  max-width: 200px;
  border-top: none;
  padding-right: 1em;
}
.right {
  text-align: right;
}


table.header {
  width: 100%;
}
table.header td {
  border: none;
  background-color: transparent;
  color: black;
}
.filename {
  color: rgb(119, 119, 119);
  font-size: 23px;
  font-weight: normal;
  height: auto;
  line-height: 100%;
}
#rfc\.abstract+p {
  font-size: 20px;
  font-weight: 300;
  line-height: 130%;
}

samp, tt, code, pre {
  font: 11pt consolas, monospace;
  font-size-adjust: none;
}
pre {
  background-color: #eee;
  border: 1px solid #ddd;
  overflow-x: auto;
  padding: 5px;
  margin: 5px;
}
.figure {
  font-style: italic;
  margin: 0 1.5em;
}

address {
  margin: 10px 0 0;
}
.vcard {
  font-style: normal;
}
.vcardline {
  display: block;
}
.vcardline .fn {
  font-weight: bold;
}
.vcardline .hidden {
  display: none;
}

dl {
  margin-left: 1em;
}
dl.dl-horizontal: {
  margin-left: 0;
}
dl > dt {
  float: left;
  margin-right: 1em;
}
dl.nohang > dt {
  float: none;
}
dl > dd {
  margin-bottom: .5em;
}
dl.compact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}
ul.empty {
  list-style-type: none;
}
ul.empty li {
  margin-top: .5em;
}

hr {
  border: 0;
  border-top: 1px solid #eee;
}

a {
  text-decoration: none;
}
a[href] {
  color: #2a6496;
}
a[href]:hover {
  background-color: #eee;
}

ol, ul, li, p {
  padding: 0;
  margin: 0.5em 0 0.5em 2em;
}
li, p {
  margin-left: 0;
}

.github-fork-ribbon-wrapper {
  display: none;
}
@media screen and (min-width: 800px) {
  /* "Fork me on GitHub" CSS ribbon based on
   * https://github.com/simonwhitaker/github-fork-ribbon-css
   */
  .github-fork-ribbon {
    position: absolute;
    padding: 2px 0;
    background-color: #a00;
    background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));
    box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);
    font: 700 12px "Helvetica Neue", Helvetica, Arial, sans-serif;

    pointer-events: auto;

    top: 38px;
    right: -45px;

    transform: rotate(45deg);
  }

  .github-fork-ribbon a[href],
  .github-fork-ribbon a[href]:hover {
    color: #fff;
    background-color: transparent;
    text-decoration: none;
    text-shadow: 0 -1px rgba(0, 0, 0, 0.5);
    text-align: center;

    width: 190px;
    line-height: 18px;

    display: inline-block;
    padding: 2px 0;

    border: 1.5px dotted #fff;
    border-color: rgba(255, 255, 255, 0.6);
  }

  .github-fork-ribbon-wrapper {
    display: block;
    width: 130px;
    height: 130px;
    position: absolute;
    overflow: hidden;
    top: 0; right: 0;
    z-index: 2;
    pointer-events: none;
  }
}
@media screen and (min-width: 1000px) {
  .github-fork-ribbon-wrapper {
    position: fixed;
  }
/*]]>*/</style>

  <link href="#rfc.toc" rel="Contents"/>
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction"/>
<link href="#rfc.section.2" rel="Chapter" title="2 Terminology"/>
<link href="#rfc.section.3" rel="Chapter" title="3 State Machine"/>
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Uniflow States"/>
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 Biflow States"/>
<link href="#rfc.section.3.3" rel="Chapter" title="3.3 Additional States and Actions"/>
<link href="#rfc.section.4" rel="Chapter" title="4 Abstract Signaling Mechanisms"/>
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 Flow Identification"/>
<link href="#rfc.section.4.2" rel="Chapter" title="4.2 Association Signaling"/>
<link href="#rfc.section.4.3" rel="Chapter" title="4.3 Stop Signaling"/>
<link href="#rfc.section.4.4" rel="Chapter" title="4.4 Timeout Exposure"/>
<link href="#rfc.section.5" rel="Chapter" title="5 Signal mappings for transport protocols"/>
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Signal mapping for TCP"/>
<link href="#rfc.section.5.2" rel="Chapter" title="5.2 Signal mapping for QUIC"/>
<link href="#rfc.section.6" rel="Chapter" title="6 IANA Considerations"/>
<link href="#rfc.section.7" rel="Chapter" title="7 Security Considerations"/>
<link href="#rfc.section.8" rel="Chapter" title="8 Acknowledgments"/>
<link href="#rfc.references" rel="Chapter" title="9 References"/>
<link href="#rfc.references.1" rel="Chapter" title="9.1 Normative References"/>
<link href="#rfc.references.2" rel="Chapter" title="9.2 Informative References"/>
<link href="#rfc.authors" rel="Chapter"/>


  <meta name="generator" content="xml2rfc version 2.5.1 - http://tools.ietf.org/tools/xml2rfc" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />

  <meta name="dct.creator" content="Kuehlewind, M., Trammell, B., and J. Hildebrand" />
  <meta name="dct.identifier" content="urn:ietf:id:draft-trammell-plus-statefulness-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2016-10-19" />
  <meta name="dct.abstract" content="This document describes a simple state machine for stateful network devices on a path between two endpoints to associate state with traffic traversing them on a per-flow basis, as well as abstract signaling mechanisms for driving the state machine. This state machine is intended to replace the de-facto use of the TCP state machine or incomplete forms thereof by stateful network devices in a transport-independent way, while still allowing for fast state timeout of non-established or undesirable flows." />
  <meta name="description" content="This document describes a simple state machine for stateful network devices on a path between two endpoints to associate state with traffic traversing them on a per-flow basis, as well as abstract signaling mechanisms for driving the state machine. This state machine is intended to replace the de-facto use of the TCP state machine or incomplete forms thereof by stateful network devices in a transport-independent way, while still allowing for fast state timeout of non-established or undesirable flows." />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
  <td class="left">Network Working Group</td>
  <td class="right">M. Kuehlewind</td>
</tr>
<tr>
  <td class="left">Internet-Draft</td>
  <td class="right">B. Trammell</td>
</tr>
<tr>
  <td class="left">Intended status: Informational</td>
  <td class="right">ETH Zurich</td>
</tr>
<tr>
  <td class="left">Expires: April 22, 2017</td>
  <td class="right">J. Hildebrand</td>
</tr>
<tr>
  <td class="left"></td>
  <td class="right">October 19, 2016</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Transport-Independent Path Layer State Management<br />
  <span class="filename">draft-trammell-plus-statefulness-00</span></p>
  
  <h1 id="rfc.abstract">
  <a href="#rfc.abstract">Abstract</a>
</h1>
<p>This document describes a simple state machine for stateful network devices on a path between two endpoints to associate state with traffic traversing them on a per-flow basis, as well as abstract signaling mechanisms for driving the state machine. This state machine is intended to replace the de-facto use of the TCP state machine or incomplete forms thereof by stateful network devices in a transport-independent way, while still allowing for fast state timeout of non-established or undesirable flows.</p>
<h1 id="rfc.status">
  <a href="#rfc.status">Status of This Memo</a>
</h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on April 22, 2017.</p>
<h1 id="rfc.copyrightnotice">
  <a href="#rfc.copyrightnotice">Copyright Notice</a>
</h1>
<p>Copyright (c) 2016 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a></li>
<li>2.   <a href="#rfc.section.2">Terminology</a></li>
<li>3.   <a href="#rfc.section.3">State Machine</a></li>
<ul><li>3.1.   <a href="#rfc.section.3.1">Uniflow States</a></li>
<li>3.2.   <a href="#rfc.section.3.2">Biflow States</a></li>
<li>3.3.   <a href="#rfc.section.3.3">Additional States and Actions</a></li>
</ul><li>4.   <a href="#rfc.section.4">Abstract Signaling Mechanisms</a></li>
<ul><li>4.1.   <a href="#rfc.section.4.1">Flow Identification</a></li>
<li>4.2.   <a href="#rfc.section.4.2">Association Signaling</a></li>
<li>4.3.   <a href="#rfc.section.4.3">Stop Signaling</a></li>
<li>4.4.   <a href="#rfc.section.4.4">Timeout Exposure</a></li>
</ul><li>5.   <a href="#rfc.section.5">Signal mappings for transport protocols</a></li>
<ul><li>5.1.   <a href="#rfc.section.5.1">Signal mapping for TCP</a></li>
<li>5.2.   <a href="#rfc.section.5.2">Signal mapping for QUIC</a></li>
</ul><li>6.   <a href="#rfc.section.6">IANA Considerations</a></li>
<li>7.   <a href="#rfc.section.7">Security Considerations</a></li>
<li>8.   <a href="#rfc.section.8">Acknowledgments</a></li>
<li>9.   <a href="#rfc.references">References</a></li>
<ul><li>9.1.   <a href="#rfc.references.1">Normative References</a></li>
<li>9.2.   <a href="#rfc.references.2">Informative References</a></li>
</ul><li><a href="#rfc.authors">Authors' Addresses</a></li>


  </ul>

  <h1 id="rfc.section.1"><a href="#rfc.section.1">1.</a> <a href="#introduction" id="introduction">Introduction</a></h1>
<p id="rfc.section.1.p.1">The boundary between the network and transport layers was originally defined to be that between information used (and potentially modified) hop-by-hop, and that used end-to-end. End-to-end information in the transport layer is associated with state at the endpoints, but processing of network-layer information was assumed to be stateless.</p>
<p id="rfc.section.1.p.2">The widespread deployment of stateful middleboxes in the Internet, such as network address and port translators (NAPT), firewalls that model the TCP state machine to distinguish packets belonging from desirable flows from backscatter and random attack traffic, and devices which keep per-flow state for reporting and monitoring purposes (e.g. IPFIX <a href="#RFC7011">[RFC7011]</a> Metering Processes), has broken this assumption, and made it more difficult to deploy non-TCP transport protocols in the Internet.</p>
<p id="rfc.section.1.p.3">The deployment of new transport protocols encapsulated in UDP with encrypted transport headers (such as QUIC <a href="#I-D.hamilton-quic-transport-protocol">[I-D.hamilton-quic-transport-protocol]</a>) will present a challenge to the operation of these devices, and their ubquity likewise threatens to impair the deployability of these protocols. There are two main causes for this problem: first, stateful devices often use an internal model of the TCP state machine to determine when TCP flows start and end, allowing them to manage state for these flows; for UDP flows, they must rely on timeouts. These timeouts are generally short relative to those for TCP <a href="#IMC-GATEWAYS">[IMC-GATEWAYS]</a>, requiring UDP- encapsulated transports either to generate unproductive keepalive traffic for long-lived sessions, or to tolerate connectivity problems and the necessity of reconnection due to loss of on-path state.</p>
<p id="rfc.section.1.p.4">This document presents a solution to this problem by defining a state machine that is transport independent to be implemented at per-flow state-keeping middleboxes as a replacement for incomplete TCP state modeling. Middleboxes implementing this state machine using signals from a common UDP encapsulation layer can have equivalent necessary state information to that provided by TCP, reducing the friction between middleboxes and these new transport protocols.</p>
<h1 id="rfc.section.2"><a href="#rfc.section.2">2.</a> <a href="#terminology" id="terminology">Terminology</a></h1>
<p id="rfc.section.2.p.1">In this document, the term &#8220;flow&#8221; is defined to be compatible with the definition given in <a href="#RFC7011">[RFC7011]</a>: A flow is defined as a set of packets passing a device on the network during a certain time interval. All packets belonging to a particular Flow have a set of common properties. Each property is defined as the result of applying a function to the values of:</p>
<p/>

<ol>
  <li>one or more network layer header fields (e.g., destination IP address) or transport layer header fields (e.g., destination port number) that the device has access to;</li>
  <li>one or more characteristics of the packet itself (e.g., number of MPLS labels, etc.);</li>
  <li>one or more of the fields derived from packet treatment at the device (e.g., next-hop IP address, the output interface, etc.).</li>
</ol>
<p id="rfc.section.2.p.3">A packet is defined as belonging to a flow if it completely satisfies all the defined properties of the flow.</p>
<p id="rfc.section.2.p.4">A bidirectional flow or biflow is defined as compatible with <a href="#RFC5103">[RFC5103]</a>, by joining the &#8220;forward direction&#8221; flow with the &#8220;reverse direction&#8221; flow, derived by reversing the direction of directional fields (ports and IP addresses). Biflows are only relevant at devices positioned so as to see all the packets in both directions of the biflow, generally on the endpoint side of the service demarcation point for either endpoint as defined in the reference path given in <a href="#RFC7398">[RFC7398]</a>.</p>
<h1 id="rfc.section.3"><a href="#rfc.section.3">3.</a> <a href="#state-machine" id="state-machine">State Machine</a></h1>
<p id="rfc.section.3.p.1">The transport-independent state machine for on-path devices is shown in <a href="#fig-states">Figure 1</a>. It relies on four states, three configurable timeouts, and a set of signals defined in <a href="#abstract-signaling-mechanisms">Section 4</a>. The states are defined as follows:</p>
<p/>

<ul>
  <li>zero: there is no state for a given flow at the device</li>
  <li>uniflow: a packet has been seen in one direction; state will be kept at the device until it is explicitly cancelled or until timeout t1 elapses without a packet.</li>
  <li>biflow: a packet has been seen in one direction and an indication that that the receiving endpoint wishes to continue the association has been seen in the opposite direction; state will be kept at the device until it is explicitly canceled or until timeout t2 elapses without a packet.</li>
  <li>closing: an established biflow is shutting down due to an explicit close indication; state will be kept at the device until timeout t3 elapses.</li>
</ul>
<p id="rfc.section.3.p.3">The three timeouts are defined as follows:</p>
<p/>

<ul>
  <li>t1 is the unidirectional idle timeout. It can be considered equivalent to the idle timeout for transport protocols where the device has no information about session start and end (e.g. most UDP protocols).</li>
  <li>t2 is the bidirectional idle timeout. It can be considered equivalent to the timeout for transport protocols where the device has information about session start and end (e.g. TCP).</li>
  <li>t3 is the closing timeout: how long the device will account additional packets to a flow after observing a stop signal, and is generally applied to ensuring a reordered stop signal doesn&#8217;t create a new flow.</li>
</ul>
<p id="rfc.section.3.p.5">Selection of timeouts is a configuration and implementation detail, but generally t3 &lt;= t1 &lt; t2.</p>
<div id="rfc.figure.1"/>
<div id="fig-states"/>
<pre>
   _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
  '                                         ' 
  '    +----+   p(s-&gt;d)   +-----+           '  
  '   /      \----------&gt;/       \----+     '  UNIFLOW
  '  (  zero  )         ( uniflow ) p(s-&gt;d) '  ONLY 
  '   \      /&lt;----------\       /&lt;---+     '  STATES
  '    +----+      t1     +-----+           '
  '_ _ _ ^_^ _ _ _ _ _ _ _ _ | _ _ _ _ _ _ _'
      t3 |  \                | association
         |   \__________     v 
       +-----+     t2   \  +----+
      /       \          \/      \----+    
     ( closing )&lt;--------( biflow ) p(s&lt;-&gt;d)
      \       /   stop    \      /&lt;---+    
       +-----+             +----+
    
</pre>
<p class="figure">Figure 1: Transport-Independent State Machine for Stateful On-Path Devices</p>
<h1 id="rfc.section.3.1"><a href="#rfc.section.3.1">3.1.</a> <a href="#uniflow-states" id="uniflow-states">Uniflow States</a></h1>
<p id="rfc.section.3.1.p.1">Every packet received by a device keeping per-flow state must associate that packet with a flow (see <a href="#flow-identification">Section 4.1</a>). When a device receives a packet associated with a flow it has not state forward, and it is configured to forward the packet instead of dropping it, it moves that flow from the zero state into the uniflow state and starts a timer t1. It resets this timer for any additional packet it forwards in the same direction as long as the flow remains in the uniflow state. When timer t1 expires on a flow in the uniflow state, the device drops state for the flow and performs any processing associated with doing so: tearing down NAT bindings, closing associated firewall pinholes, exporting flow information, and so on. The device may also drop state on a stop signal, if observed.</p>
<p id="rfc.section.3.1.p.2">Some devices will only see one side of a communication, e.g. if they are placed in a portion of a network with asymmetric routing. These devices use only the zero and uniflow states (as marked in <a href="#fig-states">Figure 1</a>.) In addition, true uniflows &#8211; protocols which are solely unidirectional (e.g. some applications over UDP) &#8211; will also use only the uniflow-only states. In either case, current devices generally don&#8217;t associate much state with observed uniflows flows, and timeout is generally sufficient to expire this state.</p>
<h1 id="rfc.section.3.2"><a href="#rfc.section.3.2">3.2.</a> <a href="#biflow-states" id="biflow-states">Biflow States</a></h1>
<p id="rfc.section.3.2.p.1">A uniflow transitions to the biflow state when the device observes an association signal. An association signal consists of a packet sent in the opposite direction from the uniflow packet(s), with certain properties as defined in <a href="#association-signaling">Section 4.2</a>. After transitioning to the biflow state, the device starts a timer t2. It resets this timer for any packet it forwards in either direction. The biflow state represents a fully established bidirectional communication. When timer t2 expires, the device assumes that the flow has shut down without signaling as such, and drops state for the flow, performing any associated processing. When a stop signal is observed in either direction, the flow transitions to the closing state.</p>
<p id="rfc.section.3.2.p.2">When a flow enters the closing state, it starts a timer t3. While the stop signal should be the last packet on a flow, the t3 timer ensures that reordered packets after the stop signal will be accounted to the flow. When this timer expires, the device drops state for the flow, performing any associated processing.</p>
<h1 id="rfc.section.3.3"><a href="#rfc.section.3.3">3.3.</a> <a href="#additional-states-and-actions" id="additional-states-and-actions">Additional States and Actions</a></h1>
<p id="rfc.section.3.3.p.1">This document is concerned only with states and transitions common to transport- and function- independent state maintenance. Devices may augment the transitions in this state diagram depending on their function. For example, a firewall that decides based on some information beyond the signals used by this state machine to shut down a flow may transition it directly to a blacklist state on shutdown. Or, a firewall may fail to forward additional packets in the uniflow state until an association signal is observed.</p>
<h1 id="rfc.section.4"><a href="#rfc.section.4">4.</a> <a href="#abstract-signaling-mechanisms" id="abstract-signaling-mechanisms">Abstract Signaling Mechanisms</a></h1>
<p id="rfc.section.4.p.1">The state machine in <a href="#state-machine">Section 3</a> requires three signals: a new flow signal (the first packet observed in a flow in the zero state), an association signal (allowing a device to verify that an endpoint wishes a bidirectional communication to be established or to continue), and a stop signal (noting that an endpoint wishes to stop a bidirectional communication).  Additional related signals may also be useful, depending on the function a device provides. There are a few different ways to implement these signals; here, we explore the properties of some potential implementations.</p>
<p id="rfc.section.4.p.2">We assume the following general requirements for these signals; parallel to those given in <a href="#draft-trammell-plus-abstract-mech">[draft-trammell-plus-abstract-mech]</a>:</p>
<p/>

<ul>
  <li>At least the endpoints can verify the integrity of the signals exposed, and shut down a transport association when that verification fails, in order to reduce the incentive for on-path devices to attempt to spoof these signals.</li>
  <li>Endpoints and devices on path can probabilistically verify that a originator of a signal is on-path.</li>
</ul>
<h1 id="rfc.section.4.1"><a href="#rfc.section.4.1">4.1.</a> <a href="#flow-identification" id="flow-identification">Flow Identification</a></h1>
<p id="rfc.section.4.1.p.1">In order to keep per-flow state, each device using this state machine must have a function it can apply to each packet to be able to extract common properties to identify the flow it is associated with. In general, the set of properties used for flow identification on presently deployed devices includes the source and destination IP address, the source and destination transport layer port number, the transport protocol number. The differentiated services field <a href="#RFC2474">[RFC2474]</a> may also be included in the set of properties defining a flow, since it may indicate different forwarding treatment.</p>
<p id="rfc.section.4.1.p.2">However, other protocols may use additional bits in their own headers for flow identification. In any case, a protocol implementing signaling for this state machine must specify the function used for flow identification.</p>
<h1 id="rfc.section.4.2"><a href="#rfc.section.4.2">4.2.</a> <a href="#association-signaling" id="association-signaling">Association Signaling</a></h1>
<p id="rfc.section.4.2.p.1">An association signal indicates that endpoint that received the first packet seen by the device is interested in continuing conversation with the sending endpoint. This signal is roughly an in-band analogue to consent signaling in ICE <a href="#RFC7675">[RFC7675]</a> that is carried to every device along the path.</p>
<p id="rfc.section.4.2.p.2">Transport-independent, path-verifiable association signaling can be implemented using a association token generated by one endpoint, present on each packet sent in the flow by that endpoint, and a response token, derived from the association token using a well-known, defined function, present on each packet sent in the flow by the opposite endpoint. We can assume a transport association has an initiator and a responder; under this assumption, the association token is chosen by the initiator, and the response token generated by the responder.</p>
<p id="rfc.section.4.2.p.3">Any packet sent by the responder with a valid response token, and without a stop signal (see <a href="#stop-signaling">Section 4.3</a>), can then be taken to be a association signal to continue a bidirectional communication. Note that, since it relies on a widely-known function, this mechanism does allow on-path devices to forge association signaling in a way that downstream on-path devices cannot detect.  However, in the presence of end-to-end signal integrity verification, this forgery will be detected by the endpoint, which MUST terminate the association on a forged association signal; the flow at the duped on-path device will transition from biflow to closing within a single packet. This reduces any attack against the association signaling mechanism to the disruption of a connection, which on-path devices can do in any case by simply refusing to forward packets.</p>
<p id="rfc.section.4.2.p.4">Association tokens MUST be chosen by initiators to be hard to guess; otherwise, off-path devices can spoof association and response signals.  Cryptographic random number generators suffice here. In choosing the number of bits for an association token, there is a tradeoff between per-packet overhead and state overhead at on-path devices, and assurance that an association token is hard to guess. This tradeoff must be evaluated at protocol design time.</p>
<p id="rfc.section.4.2.p.5">There are a few considerations in choosing a function (or functions) to generate the response token from the association token, and to verify a response token given an association token. The simplest such function is the identity function: the response token is simply the association token. Simple two-way functions (e.g. one&#8217;s complement of the association token) provide additional assurance of implementation of the protocol, and cannot be accidentally triggered by simple reflection of unknown bits in a packet. One- way functions (e.g. truncated SHA-2 hash of the association token) additionally allow on-path recognition of initiator and responder from the middle of a flow.</p>
<p id="rfc.section.4.2.p.6">In any case, a concrete implementation of association signaling must choose a single function, or mechanism for unambiguously choosing one, at both endpoints as well as along the path.</p>
<h1 id="rfc.section.4.3"><a href="#rfc.section.4.3">4.3.</a> <a href="#stop-signaling" id="stop-signaling">Stop Signaling</a></h1>
<p id="rfc.section.4.3.p.1">A stop signal is directly carried or otherwise encoded in the protocol header to indicate that a flow is ending, whether normally or abnormally, and that state associated with the flow should be torn down. Upon decoding a stop signal, a device on path should move the flow from uniflow state to null, or from biflow state to closing.</p>
<p id="rfc.section.4.3.p.2">Transports should send a stop signal only on the last packet sent in a bidirectional flow. The closing timeout t3 is intended to ensure that any packets reordered in delivery are accounted to the flow before state for it is dropped.</p>
<p id="rfc.section.4.3.p.3">We assume the encoding of a stop signal into a packet header, as with all other signals, is integrity protected end-to-end. Stop signals, as association signals, be forged by one on-path device to dupe other devices into moving flows into the closing state. However, state will be re-established by the continuing flow (and resulting association signals) after the closing timeout, and an endpoint receiving a spoofed stop signal could enter a fast re-establishment phase of the upper layer transport protocol to minimize disruption, further reducing the incentive to attackers to spoof stop signals.</p>
<h1 id="rfc.section.4.4"><a href="#rfc.section.4.4">4.4.</a> <a href="#timeout-exposure" id="timeout-exposure">Timeout Exposure</a></h1>
<p id="rfc.section.4.4.p.1">Since one of the goals of these mechanisms is to reduce the amount of non- productive keepalive traffic required for UDP-encapsulated transport protocols, they MAY be deployed together with a path-to-receiver signal with feedback as defined in <a href="#draft-trammell-plus-abstract-mech">[draft-trammell-plus-abstract-mech]</a> asking for timeouts t1, t2, and t3 for a given flow.</p>
<h1 id="rfc.section.5"><a href="#rfc.section.5">5.</a> <a href="#signal-mappings-for-transport-protocols" id="signal-mappings-for-transport-protocols">Signal mappings for transport protocols</a></h1>
<p id="rfc.section.5.p.1">We now show how this state machine can be driven by signals available in TCP and QUIC.</p>
<h1 id="rfc.section.5.1"><a href="#rfc.section.5.1">5.1.</a> <a href="#signal-mapping-for-tcp" id="signal-mapping-for-tcp">Signal mapping for TCP</a></h1>
<p id="rfc.section.5.1.p.1">A mapping of TCP flags to transitions in to the state machine in <a href="#state-machine">Section 3</a> shows how devices currently using a model of the TCP state machine can be converted to use this state machine.</p>
<p id="rfc.section.5.1.p.2">Simply speaking, an ACK flag <a href="#RFC0793">[RFC0793]</a> in the absence of the FIN or RST flags, and an in-window acknowledgment number, is synonymous with the association signal, while the RST or final FIN flags are stop signals. For a typical TCP flow:</p>
<p/>

<ol>
  <li>The initial SYN places the flow into uniflow state,</li>
  <li>The SYN-ACK sent in reply acts as a association signal and places the flow into biflow state,</li>
  <li>Any RST moves the flow into closing state, or</li>
  <li>The final FIN-ACK (not the first half-close FIN) moves the flow into closing state.</li>
</ol>
<p id="rfc.section.5.1.p.4">Note that since any valid ACK acts as an association signal, this mapping allows flows to transition to the biflow state even if the initial SYN-ACK is not observed. However, generating a stop signal from FIN does require additional TCP state modeling to prevent moving into the closing state on a half-close.</p>
<p id="rfc.section.5.1.p.5">Note that the association and stop signals derived from the TCP header are not integrity protected, and an association signal based on in-window ACK is not particularly resistant to off-path attacks; the state machine is therefore more susceptible to manipulation when used with vanilla TCP as when with a transport protocol providing full integrity protection for its headers end-to-end.</p>
<h1 id="rfc.section.5.2"><a href="#rfc.section.5.2">5.2.</a> <a href="#signal-mapping-for-quic" id="signal-mapping-for-quic">Signal mapping for QUIC</a></h1>
<p id="rfc.section.5.2.p.1">QUIC <a href="#I-D.hamilton-quic-transport-protocol">[I-D.hamilton-quic-transport-protocol]</a> as presently defined lacks only a stop signal to be able to drive this state machine. QUIC&#8217;s 64-bit connection ID suffices as an association and response token as in <a href="#association-signaling">Section 4.2</a>; the response token function is identity. QUIC&#8217;s cryptographic protocol, to be based on TLS <a href="#I-D.thomson-quic-tls">[I-D.thomson-quic-tls]</a>, will provide the necessary integrity protection to drive the state machine.</p>
<p id="rfc.section.5.2.p.2">Any number of designs could be chosen to add a stop signal compatible with the definition in <a href="#stop-signaling">Section 4.3</a> to QUIC. One is particularly promising, however. We note that the Public Reset facility described in  section 8 of <a href="#I-D.hamilton-quic-transport-protocol">[I-D.hamilton-quic-transport-protocol]</a> very nearly meets the criteria; it would need to be expanded to expose normal termination as well as abnormal termination, and to provide for endpoint detection of inauthentic termination signals.</p>
<h1 id="rfc.section.6"><a href="#rfc.section.6">6.</a> <a href="#iana-considerations" id="iana-considerations">IANA Considerations</a></h1>
<p id="rfc.section.6.p.1">This document has no actions for IANA.</p>
<h1 id="rfc.section.7"><a href="#rfc.section.7">7.</a> <a href="#security-considerations" id="security-considerations">Security Considerations</a></h1>
<p id="rfc.section.7.p.1">This document defines a state machine for transport-independent state management on middleboxes, using in-band signaling, to replace the commonly- implemented current practice of incomplete TCP state modeling on these devices. It defines new signals for state management. While these signals can be spoofed by any device on path that observes traffic in both directions, we presume the presence of end-to-end integrity protection of these signals provided by the upper-layer transport driving them. This allows such spoofing to be detected and countered by endpoints, reducing the threat from on-path devices to connection disruption, which such devices are trivially placed to perform in any case.</p>
<h1 id="rfc.section.8"><a href="#rfc.section.8">8.</a> <a href="#acknowledgments" id="acknowledgments">Acknowledgments</a></h1>
<p id="rfc.section.8.p.1">Thanks to Christian Huitema for discussions leading to this document.</p>
<p id="rfc.section.8.p.2">This work is partially supported by the European Commission under Horizon 2020 grant agreement no. 688421 Measurement and Architecture for a Middleboxed Internet (MAMI), and by the Swiss State Secretariat for Education, Research, and Innovation under contract no. 15.0268. This support does not imply endorsement.</p>
<h1 id="rfc.references"><a href="#rfc.references">9.</a> References</h1>
<h1 id="rfc.references.1"><a href="#rfc.references.1">9.1.</a> Normative References</h1>
<table>
  <tbody>
    <tr>
      <td class="reference">
        <b id="RFC5103">[RFC5103]</b>
      </td>
      <td class="top"><a>Trammell, B.</a> and <a>E. Boschi</a>, "<a href="http://tools.ietf.org/html/rfc5103">Bidirectional Flow Export Using IP Flow Information Export (IPFIX)</a>", RFC 5103, DOI 10.17487/RFC5103, January 2008.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7011">[RFC7011]</b>
      </td>
      <td class="top"><a>Claise, B.</a>, <a>Trammell, B.</a> and <a>P. Aitken</a>, "<a href="http://tools.ietf.org/html/rfc7011">Specification of the IP Flow Information Export (IPFIX) Protocol for the Exchange of Flow Information</a>", STD 77, RFC 7011, DOI 10.17487/RFC7011, September 2013.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7398">[RFC7398]</b>
      </td>
      <td class="top"><a>Bagnulo, M.</a>, <a>Burbridge, T.</a>, <a>Crawford, S.</a>, <a>Eardley, P.</a> and <a>A. Morton</a>, "<a href="http://tools.ietf.org/html/rfc7398">A Reference Path and Measurement Points for Large-Scale Measurement of Broadband Performance</a>", RFC 7398, DOI 10.17487/RFC7398, February 2015.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.references.2"><a href="#rfc.references.2">9.2.</a> Informative References</h1>
<table>
  <tbody>
    <tr>
      <td class="reference">
        <b id="draft-trammell-plus-abstract-mech">[draft-trammell-plus-abstract-mech]</b>
      </td>
      <td class="top"><a title="ETH Zurich">Trammell, B.</a>, "<a>Abstract Mechanisms for a Cooperative Path Layer under Endpoint Control</a>", September 2016.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="I-D.hamilton-quic-transport-protocol">[I-D.hamilton-quic-transport-protocol]</b>
      </td>
      <td class="top"><a>Hamilton, R.</a>, <a>Iyengar, J.</a>, <a>Swett, I.</a> and <a>A. Wilk</a>, "<a href="http://tools.ietf.org/html/draft-hamilton-quic-transport-protocol-00">QUIC: A UDP-Based Multiplexed and Secure Transport</a>", Internet-Draft draft-hamilton-quic-transport-protocol-00, July 2016.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="I-D.thomson-quic-tls">[I-D.thomson-quic-tls]</b>
      </td>
      <td class="top"><a>Thomson, M.</a> and <a>R. Hamilton</a>, "<a href="http://tools.ietf.org/html/draft-thomson-quic-tls-00">Porting QUIC to Transport Layer Security (TLS)</a>", Internet-Draft draft-thomson-quic-tls-00, March 2016.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="IMC-GATEWAYS">[IMC-GATEWAYS]</b>
      </td>
      <td class="top"><a>Hatonen, S.</a>, <a>Nyrhinen, A.</a>, <a>Eggert, L.</a>, <a>Strowes, S.</a>, <a>Sarolahti, P.</a> and <a>M. Kojo</a>, "<a>An experimental study of home gateway characteristics (Proc. ACM IMC 2010)</a>", n.d..</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC0793">[RFC0793]</b>
      </td>
      <td class="top"><a>Postel, J.</a>, "<a href="http://tools.ietf.org/html/rfc793">Transmission Control Protocol</a>", STD 7, RFC 793, DOI 10.17487/RFC0793, September 1981.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC2474">[RFC2474]</b>
      </td>
      <td class="top"><a>Nichols, K.</a>, <a>Blake, S.</a>, <a>Baker, F.</a> and <a>D. Black</a>, "<a href="http://tools.ietf.org/html/rfc2474">Definition of the Differentiated Services Field (DS Field) in the IPv4 and IPv6 Headers</a>", RFC 2474, DOI 10.17487/RFC2474, December 1998.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7675">[RFC7675]</b>
      </td>
      <td class="top"><a>Perumal, M.</a>, <a>Wing, D.</a>, <a>Ravindranath, R.</a>, <a>Reddy, T.</a> and <a>M. Thomson</a>, "<a href="http://tools.ietf.org/html/rfc7675">Session Traversal Utilities for NAT (STUN) Usage for Consent Freshness</a>", RFC 7675, DOI 10.17487/RFC7675, October 2015.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.authors">
  <a href="#rfc.authors">Authors' Addresses</a>
</h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Mirja Kuehlewind</span> 
	  <span class="n hidden">
		<span class="family-name">Kuehlewind</span>
	  </span>
	</span>
	<span class="org vcardline">ETH Zurich</span>
	<span class="adr">
	  <span class="vcardline">Gloriastrasse 35</span>

	  <span class="vcardline">
		<span class="locality">8092 Zurich</span>,  
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline">Switzerland</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:mirja.kuehlewind@tik.ee.ethz.ch">mirja.kuehlewind@tik.ee.ethz.ch</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Brian Trammell</span> 
	  <span class="n hidden">
		<span class="family-name">Trammell</span>
	  </span>
	</span>
	<span class="org vcardline">ETH Zurich</span>
	<span class="adr">
	  <span class="vcardline">Gloriastrasse 35</span>

	  <span class="vcardline">
		<span class="locality">8092 Zurich</span>,  
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline">Switzerland</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:ietf@trammell.ch">ietf@trammell.ch</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Joe Hildebrand</span> 
	  <span class="n hidden">
		<span class="family-name">Hildebrand</span>
	  </span>
	</span>
	<span class="org vcardline"></span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:hildjj@cursive.net">hildjj@cursive.net</a></span>

  </address>
</div>

</body>
</html>
